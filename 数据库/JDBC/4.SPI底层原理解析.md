å‰é¢å·²ç»è®²è¿‡`SPI`çš„åŸºæœ¬å®ç°åŸç†äº†ï¼Œ`demo`ä¹ŸåŸºæœ¬å®ç°äº†ï¼Œå†æ¥è¯´è¯´`SPI`ã€‚
![](https://markdownpicture.oss-cn-qingdao.aliyuncs.com/blog/20201124235140.png)

**èƒŒæ™¯ï¼š`SPI`æ˜¯ä»€ä¹ˆï¼Ÿ**
`SPI`ï¼Œå³æ˜¯`Service Provider Interface`ï¼Œæ˜¯ä¸€ç§æœåŠ¡æä¾›ï¼ˆæ¥å£å®ç°ï¼‰å‘ç°æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡`ClassPath`è·¯å¾„ä¸‹çš„`META-INF/Service`æ–‡ä»¶æŸ¥æ‰¾æ–‡ä»¶ï¼ŒåŠ è½½é‡Œé¢å®šä¹‰çš„ç±»ã€‚
ä¸€èˆ¬å¯ä»¥ç”¨æ¥å¯ç”¨æ¡†æ¶æ‹“å±•å’Œæ›¿æ¢ç»„ä»¶ï¼Œæ¯”å¦‚åœ¨æœ€å¸¸è§çš„æ•°æ®åº“è¿æ¥`JDBC`ä¸­ï¼Œ`java.sql.Driver`,ä¸åŒçš„æ•°æ®åº“äº§å•†å¯ä»¥å¯¹æ¥å£åšä¸ä¸€æ ·çš„å®ç°ï¼Œä½†æ˜¯`JDK`æ€ä¹ˆçŸ¥é“åˆ«äººæœ‰å“ªäº›å®ç°å‘¢ï¼Ÿè¿™å°±éœ€è¦`SPI`,å¯ä»¥æŸ¥æ‰¾åˆ°æ¥å£çš„å®ç°ï¼Œå¯¹å…¶è¿›è¡Œæ“ä½œã€‚
ç”¨ä¸¤ä¸ªå­—è§£é‡Šï¼š**è§£è€¦**ã€‚

å†ç®€å•ç‚¹è¯´ï¼Ÿ
å°±æ˜¯`Java`æ ¸å¿ƒåŒ…ä¸çŸ¥é“ç¬¬ä¸‰æ–¹çš„åŒ…ä¼šæ€ä¹ˆå®ç°ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†ä¸€ä¸ªè§„åˆ™ï¼šä½ è¦å¯¹è¿™ä¸ªç±»æ‹“å±•ï¼Œé‚£ä½ å°±æŠŠä½ çš„å®ç°ç±»é…ç½®åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œæ–‡ä»¶åå°±æ˜¯ä½ è¦æ‹“å±•çš„æ¥å£ï¼Œè¿™æ ·å­ï¼Œæˆ‘åªè¦ç”¨`ServiceLoader`åŠ è½½æ¥å£ï¼Œæˆ‘å°±å¯ä»¥è·å–åˆ°å®ç°ç±»çš„å®ä¾‹ã€‚

å¯¹äº`java`æ ¸å¿ƒåŒ…æ¥è¯´ï¼Œæˆ‘ä¸çŸ¥é“ä½ è¦æ€ä¹ˆå®ç°æ¥å£ï¼Œä½†æ˜¯åªè¦ä½ æŒ‰æˆ‘è¯´çš„åšï¼Œé…ç½®å¥½ï¼Œæˆ‘å°±èƒ½ä¿è¯ä½ åªè¦å¼•å…¥ä½ è‡ªå·±çš„åŒ…ï¼Œæˆ‘å°±å¯ä»¥è¿è¡Œåˆ°ä½ çš„ä»£ç ã€‚
![](https://markdownpicture.oss-cn-qingdao.aliyuncs.com/blog/20201125000711.png)

æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š
``` java
    ServiceLoader<DBConnectionService>  serviceLoader= ServiceLoader.load(DBConnectionService.class);
```

æ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶å‡è®¾è‡ªå·±å¯¹`ServiceLoader`å·²ç»ååˆ†å¥½å¥‡äº†,è¿™æ˜¯ä»€ä¹ˆï¼Ÿè¿™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿè¿™ä¹ˆç‰›é€¼ï¼Ÿ

é‚£å°±çœ‹æºç ï¼Ÿå¤œæ·±äººé™åˆšåˆšå¥½ï¼Œç™½å¤©ä¹Ÿçœ‹ä¸ä¸‹å»ã€‚

**è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª`ServiceLoader`æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œå®ç°äº†`Iterable`ï¼Œè¯´æ˜äº†ä»€ä¹ˆï¼Ÿè¯´æ˜å®ƒçš„åŠŸèƒ½æœ‰ä¸€éƒ¨åˆ†å’Œé›†åˆæ˜¯å·®ä¸å¤šçš„ï¼Œå¯ä»¥å°†å¤šä¸ªæœåŠ¡çš„å®ç°ç±»åŠ è½½åœ¨é‡Œé¢ï¼ï¼ï¼å¯ä»¥é€šè¿‡éå†çš„æ–¹å¼ï¼Œä¸€ä¸€å–å‡ºæ¥**

å…ˆçœ‹çœ‹`ServiceLoader`çš„ç±»æˆå‘˜æ¥å£ï¼Œä¸æ€¥ç€çœ‹`load()`å‡½æ•°ï¼š
``` java
public final class ServiceLoader<S>
    implements Iterable<S>
{
    // è¯»å–é…ç½®æ–‡ä»¶çš„è·¯å¾„
    private static final String PREFIX = "META-INF/services/";

    // åŠ è½½çš„æœåŠ¡ç±»æˆ–è€…æ¥å£çš„å®ç°ç±»
    private final Class<S> service;

    // ç±»åŠ è½½å™¨
    private final ClassLoader loader;

    // è®¿é—®æ§åˆ¶å™¨
    private final AccessControlContext acc;

    // å·²åŠ è½½çš„æœåŠ¡ç±»é›†åˆ
    private LinkedHashMap<String,S> providers = new LinkedHashMap<>();

    // å†…éƒ¨ç±»ï¼ŒçœŸæ­£åŠ è½½æœåŠ¡ç±»çš„è¿­ä»£å™¨
    private LazyIterator lookupIterator;

    ...
}
```
ç°åœ¨æ¥çœ‹`load()`å‡½æ•°,å…¶å®é‡Œé¢è°ƒç”¨çš„ä¹Ÿè¿˜æ˜¯`serviceLoader`æœ¬èº«çš„æ„é€ å™¨ï¼Œä¸¤ä¸ªloadæ–¹æ³•
- ä¸€ä¸ªåªéœ€è¦ä¼ å…¥éœ€è¦å®ç°çš„æœåŠ¡æ¥å£`service`
- å¦ä¸€ä¸ªåˆ™æ˜¯éœ€è¦åŒæ—¶ä¼ å…¥ç±»åŠ è½½å™¨`loader`

```java
    // å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä½œä¸ºé»˜è®¤åŠ è½½å™¨
    public static <S> ServiceLoader<S> load(Class<S> service) {
        // è·å–ç±»åŠ è½½å™¨
        ClassLoader cl = Thread.currentThread().getContextClassLoader();
        // è°ƒç”¨å¦å¤–ä¸€ä¸ªåŠ è½½å™¨
        return ServiceLoader.load(service, cl);
    }

    // ä¸¤ä¸ªå‚æ•°çš„åŠ è½½æ–¹æ³•
    public static <S> ServiceLoader<S> load(Class<S> service,
                                            ClassLoader loader)
    {
        return new ServiceLoader<>(service, loader);
    }
```
æˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹`serviceLoader`çš„æ„é€ å™¨ï¼š
```java
    private ServiceLoader(Class<S> svc, ClassLoader cl) {
        // è¦åŠ è½½çš„æ¥å£
        service = Objects.requireNonNull(svc, "Service interface cannot be null");
        // åŠ è½½å™¨ï¼Œå¦‚æœä¸ºnullåˆ™é»˜è®¤ä½¿ç”¨ç³»ç»ŸåŠ è½½å™¨è¿›è¡ŒåŠ è½½
        loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl;
        // æ§åˆ¶è®¿é—®å™¨
        acc = (System.getSecurityManager() != null) ? AccessController.getContext() : null;
        // é‡æ–°åŠ è½½
        reload();
    }
```

çœ‹é‡æ–°åŠ è½½çš„æ–¹æ³•ï¼š
```java
    public void reload() {
        // æ¸…ç©ºå·²ç»åŠ è½½çš„æœåŠ¡ç±»
        providers.clear();
        // åˆå§‹åŒ–æŸ¥æ‰¾åŠ è½½ç±»çš„è¿­ä»£å™¨
        lookupIterator = new LazyIterator(service, loader);
    }
```

æŸ¥æ‰¾åŠ è½½ç±»çš„è¿­ä»£å™¨ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä»åå­—æ¥çœ‹ï¼Œæ˜¯ä¸€ä¸ªæ‡’åŠ è½½å™¨ï¼Œå°±æ˜¯å»¶è¿ŸåŠ è½½ï¼Œä»åå­—æ¥çœ‹ï¼Œå¤§æ¦‚èƒ½çŒœåˆ°ï¼Œè¿™ä¸ªå°±æ˜¯ä½¿ç”¨çš„æ—¶å€™æ‰åŠ è½½ï¼ŒçœŸçš„æ˜¯è¿™æ ·ä¹ˆï¼Ÿï¼Ÿï¼Ÿæ¥ç€çœ‹ä¸‹å»ï¼š

ä¸Šé¢ ğŸ‘† æˆ‘ä»¬è¯´åˆ°`ServiceLoader`å…¶å®æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œå®ç°äº†Iteratoræ¥å£ï¼Œè¯´æ˜å®ƒå¯ä»¥è¢«éå†ï¼Œéå†çš„å…ƒç´ æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„æˆå‘˜å˜é‡`LinkedHashMap<String,S> providers`ï¼Œå®ç°çš„æœåŠ¡éƒ½åŠ è½½åœ¨é‡Œé¢äº†ã€‚
![](https://markdownpicture.oss-cn-qingdao.aliyuncs.com/blog/20201126003812.png)

é‚£æˆ‘ä»¬å°±çœ‹çœ‹éå†çš„æ—¶å€™æ€ä¹ˆå–çš„ï¼Ÿ
è¿™å°±æ¶‰åŠåˆ°äº†`Iterable`æ¥å£çš„æ–¹æ³•`foreach()`äº†ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹ã€‚
æ€»æ‰€å‘¨çŸ¥ï¼Œ`Iterable`æ¥å£çš„æ–¹æ³•å¦‚ä¸‹ï¼š
```java
    Iterator<T> iterator();
    default void forEach(Consumer<? super T> action) {
        Objects.requireNonNull(action);
        for (T t : this) {
            action.accept(t);
        }
    }
    default Spliterator<T> spliterator() {
        return Spliterators.spliteratorUnknownSize(iterator(), 0);
    }
```
é‚£æˆ‘çŒœéå†çš„æ–¹æ³•åº”è¯¥è¢«`ServiceLoader`å®ç°çš„æ—¶å€™ï¼Œå·²ç»é‡å†™äº†,æœä¸å…¶ç„¶ï¼š
çœ‹è·å–`Iterator`çš„æ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸ªæƒŠå¤©ãŠ™ï¸å¯†ï¼šä¹Ÿå°±æ˜¯å…¶å®æˆ‘ä»¬éå†çš„æ—¶å€™ï¼Œä¼˜å…ˆæ˜¯ä½¿ç”¨å·²çŸ¥çš„é›†åˆè¿­ä»£å™¨ï¼Œè¿™ä¸ªé›†åˆï¼Œå°±æ˜¯å­˜å‚¨æˆ‘ä»¬çš„æœåŠ¡æä¾›è€…çš„é›†åˆï¼Œä¹Ÿå°±æ˜¯å·²ç»åŠ è½½çš„æœåŠ¡ç±»é›†åˆã€‚å¦‚æœè¿™ä¸ªé›†åˆå·²ç»éå†å®Œæˆçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨æŸ¥æ‰¾è¿­ä»£å™¨å»æŸ¥æ‰¾ï¼Œä¸ç®¡`next()`è¿˜æ˜¯`hasNext()`æ–¹æ³•ï¼Œéƒ½æ˜¯è¿™æ ·çš„ã€‚
åŒæ—¶å·²ç»åŠ è½½çš„æœåŠ¡ï¼Œæ˜¯ä¸å¯ä»¥è¢«ç§»é™¤çš„ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸€ç‚¹ï¼Œåœ¨ç§»é™¤çš„æ—¶å€™ä¼šè¿”å›å¼‚å¸¸ã€‚

```java
    public Iterator<S> iterator() {
        return new Iterator<S>() {

            //  è¢«æŸ¥æ‰¾åˆ°çš„å·²çŸ¥çš„æœåŠ¡æä¾›è€…çš„è¿­ä»£å™¨
            Iterator<Map.Entry<String,S>> knownProviders
                = providers.entrySet().iterator();

            // å¦‚æœå·²çŸ¥çš„è¿­ä»£å™¨ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨æœåŠ¡æä¾›è€…çš„é›†åˆè¿­ä»£å™¨ï¼Œå¦‚æœè¿™ä¸ªæœ‰ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å›trueï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆå°±ä¼šè°ƒç”¨æŸ¥æ‰¾è¿­ä»£å™¨çš„hasNext()
            public boolean hasNext() {
                if (knownProviders.hasNext())
                    return true;
                return lookupIterator.hasNext();
            }

            public S next() {
                // å¦‚æœå­˜å‚¨å·²çŸ¥çš„æœåŠ¡æä¾›è€…çš„è¿­ä»£å™¨è¿˜æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆç›´æ¥å–å‡ºæ¥ç›´æ¥è¿”å›å³å¯ï¼Œå¦åˆ™å°±ç”¨æŸ¥æ‰¾è¿­ä»£å™¨å»æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
                if (knownProviders.hasNext())
                    return knownProviders.next().getValue();
                return lookupIterator.next();
            }

            // ä¸å¯ä»¥ç§»é™¤å·²ç»åŠ è½½é¢æœåŠ¡æä¾›è€…
            public void remove() {
                throw new UnsupportedOperationException();
            }

        };
    }
```
é‚£`Iterator`çš„å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿ
![](https://markdownpicture.oss-cn-qingdao.aliyuncs.com/blog/20201126005629.png)
å½“ç„¶æ˜¯ç”¨äº†é»˜è®¤å®ç°äº†ï¼Œå…¶ä»–ä¸¤ä¸ªæ–¹æ³•éƒ½åŠ äº†`default`å…³é”®å­—ï¼Œ`ServiceLoader`æ²¡æœ‰å»å®ç°å®ƒï¼Œå¯ä»¥ä¸å®ç°ï¼Œç”¨é»˜è®¤å®ç°å°±å¯ä»¥ã€‚

æ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿå½“ç„¶æ˜¯è¿™ä¸ª`lookupIterator`ï¼Œå®ƒå¯æ˜¯ä¸€ä¸ªå»¶è¿ŸåŠ è½½å™¨ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Œæˆ‘è§‰å¾—åº”è¯¥å’Œä¸Šé¢çš„åˆ†ææœ‰å…³ï¼Œå…ˆéå†å·²ç»åŠ è½½çš„ï¼Œç„¶åæ²¡æœ‰äº†ï¼Œæ‰ä¼šä½¿ç”¨è¿™ä¸ªå»¶è¿ŸæŸ¥æ‰¾è¿­ä»£å™¨ï¼Œä»å®ƒçš„åå­—å°±å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹å‡ºæ¥ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªæŸ¥æ‰¾çš„è¿­ä»£å™¨ï¼Œåˆ«äººéƒ½æ˜¯è¿­ä»£éå†å·²ç»å­˜åœ¨çš„å…ƒç´ ï¼Œå®ƒå€’å¥½ï¼Œæ‡’åˆ°ä¸€å®šç¨‹åº¦äº†ï¼Œç”¨æ¥æŸ¥æ‰¾ã€‚

åºŸè¯å°‘è¯´ï¼Œç›´æ¥çœ‹çœ‹å®ƒæ€ä¹ˆå®ç°çš„ï¼Œè¿™ä¹ˆğŸ‚ ç‰›ï¼
åœ¨å›å¤´çœ‹çœ‹å‰é¢åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ„é€ æ˜¯è¿™æ ·å­çš„ï¼š
```java
        // åˆå§‹åŒ–æŸ¥æ‰¾åŠ è½½ç±»çš„è¿­ä»£å™¨
        lookupIterator = new LazyIterator(service, loader);
```
å¯ä»¥çœ‹åˆ°å…¶å®æ˜¯å°†éœ€è¦åŠ è½½çš„æœåŠ¡æ¥å£ä»¥åŠç±»åŠ è½½å™¨ä¼ é€’è¿›æ¥äº†ã€‚
ä»£ç ç²¾ç®€ï¼Œçœ‹ğŸ‘‡ä¸‹é¢çš„ä»£ç åŠ æ³¨è§£ï¼Œåº”è¯¥å¾ˆæ¸…æ™°äº†ã€‚

```java
    private class LazyIterator
        implements Iterator<S>
    {
        // éœ€è¦åŠ è½½çš„æœåŠ¡
        Class<S> service;
        // ç±»åŠ è½½å™¨
        ClassLoader loader;
        // å®ç°ç±»çš„urlï¼ˆå¤šä¸ªï¼‰
        Enumeration<URL> configs = null;
        // å®ç°ç±»çš„å…¨åï¼ˆå¤šä¸ªï¼‰
        Iterator<String> pending = null;
        // è¿­ä»£å™¨ä¸­ä¸‹ä¸€ä¸ªå®ç°ç±»çš„å…¨å
        String nextName = null;

        // æ„é€ å™¨å…¶å®æ²¡æœ‰ä»€ä¹ˆæ“ä½œï¼Œå•çº¯ä¿å­˜
        private LazyIterator(Class<S> service, ClassLoader loader) {
            this.service = service;
            this.loader = loader;
        }

        // è·å–ä¸‹ä¸€ä¸ª
        public S next() {
            // å¦‚æœæ§åˆ¶è®¿é—®å™¨æ˜¯ç©ºçš„
            if (acc == null) {
                // è°ƒç”¨è·å–ä¸‹ä¸€ä¸ªå…ƒç´ 
                return nextService();
            } else {
                // ç‰¹æƒåŠ¨ä½œï¼Œé‡å†™çš„å…¶å®ä¹Ÿæ˜¯è°ƒç”¨nextService()
                PrivilegedAction<S> action = new PrivilegedAction<S>() {
                    public S run() { return nextService(); }
                };
                // é€šè¿‡æ§åˆ¶è®¿é—®å™¨çš„ç‰¹æƒè®¿é—®ï¼Œè·³è¿‡æ£€æŸ¥
                return AccessController.doPrivileged(action, acc);
            }
        }
        // æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ 
        public boolean hasNext() {
            if (acc == null) {
                // å¦‚æœè®¿é—®æ§åˆ¶å™¨æ˜¯nullï¼Œé‚£ä¹ˆä¹…ç›´æ¥è°ƒç”¨hasNextServiceæ–¹æ³•
                return hasNextService();
            } else {
                // ç”Ÿæˆç‰¹æƒåŠ¨ä½œ
                PrivilegedAction<Boolean> action = new PrivilegedAction<Boolean>() {
                    public Boolean run() { return hasNextService(); }
                };
                // ä½¿ç”¨è®¿é—®æ§åˆ¶å™¨æ‰§è¡Œç‰¹æƒåŠ¨ä½œ
                return AccessController.doPrivileged(action, acc);
            }
        }

        // ä¸å¯ä»¥ç§»é™¤
        public void remove() {
            throw new UnsupportedOperationException();
        }

        // æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ 
        private boolean hasNextService() {
            // å¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ çš„å…¨ç±»ååå­—ä¸ä¸ºnullï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ 
            if (nextName != null) {
                return true;
            }
            // å¦‚æœè¿™ä¸ªå®ç°ç±»çš„urlæ˜¯ç©ºçš„ï¼Œæ€ä¹ˆåŠï¼ŸåŠ è½½è¿›å»
            if (configs == null) {
                try {
                    // è·å–å…¨å
                    String fullName = PREFIX + service.getName();
                    // å¦‚æœç±»åŠ è½½å™¨æ˜¯null
                    if (loader == null)
                        // é€šè¿‡å…¨åï¼Œæ‹¿åˆ°å…¨åçš„urlï¼Œè¿™ä¸ªurlå…¶å®å°±æ˜¯æ ¹æ®åå­—æ‰¾åˆ°çš„é…ç½®æ–‡ä»¶çš„è·¯å¾„
                        configs = ClassLoader.getSystemResources(fullName);
                    else
                        // å¦åˆ™è°ƒç”¨loaderè‡ªèº«çš„æ–¹æ³•è·å–
                        configs = loader.getResources(fullName);
                } catch (IOException x) {
                    fail(service, "Error locating configuration files", x);
                }
            }

            // å¦‚æœå®ç°ç±»çš„å…¨é™å®šç±»åæ˜¯ç©ºçš„ï¼Œé‚£å°±è‚¯å®šéœ€è¦ä»æ–‡ä»¶é‡Œé¢è¯»å‡ºæ¥å‘€ï¼Œå› ä¸ºæ–‡ä»¶åæ˜¯æ¥å£ï¼Œé‡Œé¢é…ç½®çš„æ˜¯æ¥å£çš„å®ç°ç±»ï¼Œpendingä¿å­˜çš„å°±æ˜¯å®ç°ç±»
            while ((pending == null) || !pending.hasNext()) {
                // å¦‚æœéœ€è¦è¯»å–çš„é…ç½®æ²¡æœ‰è¦è¯»çš„äº†
                if (!configs.hasMoreElements()) {
                    // ç›´æ¥è¿”å›false
                    return false;
                }
                // å¦åˆ™éœ€è¦è§£æé…ç½®æ–‡ä»¶é‡Œé¢çš„å†…å®¹
                pending = parse(service, configs.nextElement());
            }
            // ä¸‹ä¸€ä¸ªserviceçš„åå­—å°±æ›´æ–°ä¸ºè¯»å–åˆ°çš„æ¥å£å®ç°ç±»ï¼Œå¦‚æœæ–‡ä»¶é‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰é…ç½®ï¼Œé‚£å°±å¾ˆæœ‰å¯èƒ½æ˜¯ç©ºçš„ã€‚
            nextName = pending.next();
            return true;
        }

        // è·å–ä¸‹ä¸€ä¸ªæ¥å£å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡
        private S nextService() {
            // å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªæœåŠ¡ï¼Œä¼šæŠ›å¼‚å¸¸
            if (!hasNextService())
                throw new NoSuchElementException();
            // ä¸‹ä¸€ä¸ªå®ç°ç±»çš„åç§°,ä¿å­˜èµ·æ¥
            String cn = nextName;
            // ç½®ç©º
            nextName = null;
            Class<?> c = null;
            try {
                // é€šè¿‡åå°„æ¥æ„é€ æœåŠ¡å¯¹è±¡ï¼Œå°±æ˜¯å®ç°ç±»
                c = Class.forName(cn, false, loader);
            } catch (ClassNotFoundException x) {
                fail(service,
                     "Provider " + cn + " not found");
            }
            // åˆ¤æ–­æœåŠ¡cæ˜¯ä¸æ˜¯å®ç°æ¥è‡ªäºservice,ä¸¤è€…æ˜¯ä¸æ˜¯ç»§æ‰¿å…³ç³»
            if (!service.isAssignableFrom(c)) {
                fail(service,
                     "Provider " + cn  + " not a subtype");
            }
            try {
                // å¼ºè£…ç±»å‹
                S p = service.cast(c.newInstance());
                // å°†è§£æçš„æœåŠ¡å®ç°æ”¾åˆ°å·²ç»å‘ç°çš„é›†åˆä¸­
                providers.put(cn, p);
                // è¿”å›å½“å‰çš„å®ç°
                return p;
            } catch (Throwable x) {
                fail(service,
                     "Provider " + cn + " could not be instantiated",
                     x);
            }
            throw new Error();          // This cannot happen
        }
    }
```

é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œè¿™ä¸ªå»¶è¿ŸåŠ è½½å™¨ï¼Œä¼šå»è¯»å–é…ç½®ç±»ï¼Œä»¥åŠå®ç°çš„çš„æ¥å£ï¼Œå°†å®ç°ç±»å…¨ç±»åæ”¾åˆ°`configs`ï¼Œç„¶åé€šè¿‡åå°„çš„å½¢å¼æ„å»ºå®ä¾‹å¯¹è±¡ï¼Œå®ä¾‹åŒ–ä¹‹åæ‰æ”¾åˆ°providersä¸­ï¼Œç„¶åè¿”å›å®ç°ç±»å¯¹è±¡ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè®¿é—®æ§åˆ¶å™¨æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ç‰¹æƒæ‰§è¡Œï¼š`AccessController.doPrivileged(action, acc);`,è·å–åˆ°æœåŠ¡å®ç°çš„æ—¶å€™ï¼Œä¹Ÿä¼šåˆ¤æ–­æ˜¯ä¸æ˜¯å®ç°æ¥è‡ªäºæˆ‘ä»¬éœ€è¦å®ç°çš„æ¥å£ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œè°ƒç”¨çš„æ˜¯`service.isAssignableFrom(c)`ã€‚

ä¸Šé¢è¿˜æœ‰ä¸€æ®µè§£æé…ç½®çš„ä»£ç æ²¡æœ‰è¯´æ˜ï¼Œè¡¥ä¸Šï¼š
```java
    private Iterator<String> parse(Class<?> service, URL u)
        throws ServiceConfigurationError
    {
        // è¾“å…¥æµ
        InputStream in = null;
        // bufferè¯»å…¥
        BufferedReader r = null;
        ArrayList<String> names = new ArrayList<>();
        try {
            in = u.openStream();
            r = new BufferedReader(new InputStreamReader(in, "utf-8"));
            int lc = 1;
            // æŒ‰ç…§æ¯ä¸€è¡Œæ¥è¯»å…¥
            while ((lc = parseLine(service, u, r, lc, names)) >= 0);
        } catch (IOException x) {
            fail(service, "Error reading configuration file", x);
        } finally {
            try {
                if (r != null) r.close();
                if (in != null) in.close();
            } catch (IOException y) {
                fail(service, "Error closing configuration file", y);
            }
        }
        // è¿”å›çš„å…¶å®æ˜¯å®ç°ç±»å…¨é™å®šåçš„é›†åˆè¿­ä»£å™¨
        return names.iterator();
    }

    private int parseLine(Class<?> service, URL u, BufferedReader r, int lc,
                          List<String> names)
        throws IOException, ServiceConfigurationError
    {
        String ln = r.readLine();
        if (ln == null) {
            return -1;
        }
        // å¯¹äº#å·åé¢çš„å†…å®¹ä¸åŠ è½½ï¼Œç›´æ¥å¿½ç•¥æ‰
        int ci = ln.indexOf('#');
        if (ci >= 0) ln = ln.substring(0, ci);
        ln = ln.trim();
        int n = ln.length();
        if (n != 0) {
            if ((ln.indexOf(' ') >= 0) || (ln.indexOf('\t') >= 0))
                fail(service, u, lc, "Illegal configuration-file syntax");
            int cp = ln.codePointAt(0);
            if (!Character.isJavaIdentifierStart(cp))
                fail(service, u, lc, "Illegal provider-class name: " + ln);
            for (int i = Character.charCount(cp); i < n; i += Character.charCount(cp)) {
                cp = ln.codePointAt(i);
                if (!Character.isJavaIdentifierPart(cp) && (cp != '.'))
                    fail(service, u, lc, "Illegal provider-class name: " + ln);
            }
            // æ²¡æœ‰åŠ è½½è¿‡æ‰ä¼šæ·»åŠ è¿›å»
            if (!providers.containsKey(ln) && !names.contains(ln))
                names.add(ln);
        }
        return lc + 1;
    }
```


åˆ°è¿™é‡Œï¼Œ`serviceLoader`çš„å†…å®¹å°±è§£è¯»å®Œæ¯•äº†ï¼Œæ€æƒ³æŒºå¥½çš„ï¼Œæœ‰ä¸¤ä¸ªè¿­ä»£å™¨ï¼Œä¸€ä¸ªæ˜¯æä¾›æœåŠ¡çš„é›†åˆæœ¬èº«çš„è¿­ä»£å™¨ï¼Œè¿­ä»£å®Œæˆä¹‹åï¼Œæ‰ä¼šå»ä½¿ç”¨å»¶è¿Ÿè°ƒç”¨`lookup`è¿­ä»£å™¨ï¼Œè§¦å‘å¯»æ‰¾æ“ä½œï¼Œå¦‚æœæŸ¥æ‰¾äº†ï¼Œé‚£ä¹ˆå°±åŠ è½½åˆ°é›†åˆä¸­ï¼Œä¸‹æ¬¡å°±ä¸ç”¨å†æ‰¾äº†ã€‚

æŸ¥æ‰¾çš„æ—¶å€™ï¼Œç›´æ¥æ ¹æ®è¯¥è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œæ–‡ä»¶åå°±æ˜¯æ¥å£ï¼Œæ¥å£é‡Œé¢æ¯ä¸€è¡Œéƒ½æ˜¯æ¥å£çš„å®ç°ç±»ã€‚

å®ä¾‹åŒ–æ¥å£å®ç°ç±»çš„æ—¶å€™ï¼Œå…¶å®æ˜¯ä½¿ç”¨äº†åå°„ï¼Œç„¶ååˆ¤æ–­ç±»å‹ä¹‹åï¼Œç±»å‹è½¬æ¢æˆä¸ºâ¤´ï¸ä¸Šè½¬å‹ï¼Œæ”¾åˆ°å·²ç»å‘ç°çš„æœåŠ¡é›†åˆä¸­ï¼Œè¿”å›ã€‚







